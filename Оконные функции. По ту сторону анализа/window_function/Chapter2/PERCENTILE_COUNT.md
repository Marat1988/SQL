<p style="text-align: justify;">Функция PERCENTILE_CONT(0.9) WITHIN GROUP (ORDER BY Amount) в SQL Server использует интерполяционный (линейный) алгоритм для вычисления перцентиля. В отличие от PERCENTILE_DISC, который выбирает фактическое значение, PERCENTILE_CONT может возвращать значение, расположенное между двумя существующими точками данных, если перцентиль не совпадает с точкой в наборе.</p>
<p>Как работает PERCENTILE_CONT(0.9)</p>
<div>
        <ul>
            <li>Отсортировать данные по указанному столбцу (Amount).</li>
            <li>Определить позицию, основанную на перцентиле:
                <p style="font-weight: bold;">Position=(N−1)×P+1</p>
                Где:
                <ol>
                    <li>N — общее число строк</li>
                    <li>P=0.9 — запрошенный перцентиль.</li>
                </ol>
            </li>
            <li>
                Разделить позицию на целую часть и дробную часть: Floor=⌊Position⌋ Fraction=Position−Floor
            </li>
            <li>Вычислить перцентиль как линейную интерполяцию между значениями на позициях Floor и Floor + 1:
                <p style="font-weight: bold;">Percentile=V<sub>Floor</sub>+(Fraction)×(V<sub>Floor + 1</sub>−V<sub>Floor</sub>)</p>
                где:
                <ol>
                    <li>V<sub>Floor</sub> — значение на позиции Floor,</li>
                    <li>V<sub>Floor+1</sub> — значение на следующей позиции.</li>
                </ol>
            </li>
        </ul>
        Если Position — целое число, то функция возвращает значение на этой позиции без интерполяции.
</div>
<div>
        Пример на данных Используем те же значения:
        <div style="background-color: red; color: white; padding: 20px; width: fit-content;">100, 200, 300, 400, 500, 600, 700, 800, 900, 1000</div>
        <div>Общее число N=10. Для P=0.9: Position=(10−1)×0.9+1=9×0.9+1=8.1+1=9.1 Floor = 9, Fraction = 0.1. Значения:
            <ul>
                <li>
                    V<sub>9</sub>=900
                </li>
                <li>
                    V<sub>10</sub>=1000
                </li>
            </ul>
        </div>
        <div>Интерполяция: 900+0.1×(1000−900)=900+0.1×100=900+10=910</div>
        <div>Ответ: PERCENTILE_CONT(0.9) вернёт 910.</div>
</div>
<div>
        Итог:
        <ol>
            <li>Алгоритм основан на линейной интерполяции между двумя соседними значениями.</li>
            <li>Он вычисляет значение, которое находится точно на 90-м перцентиле, даже если это не является фактическим значением в данных.</li>
            <li>В отличие от дискретного подхода, этот алгоритм дает более гладкий и точный результат для перцентилей, не совпадающих с существующими точками.</li>
        </ol>
</div>